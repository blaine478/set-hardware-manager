<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Hardware Order App</title>
  <!-- Load React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Load Babel for JSX transformation -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <!-- Load Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // Expose Firebase functions to global scope for React app
    window.firebase = { initializeApp, getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, getStorage, ref, uploadBytes, getDownloadURL };
  </script>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase configuration (replace with your actual Firebase config from Firebase Console)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    let db, storage;
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.getFirestore(app);
      storage = firebase.getStorage(app);
    } catch (error) {
      console.error('Firebase initialization error:', error);
    }

    function App() {
      const [formData, setFormData] = useState({
        itemName: '',
        pickupFrom: '',
        orderNumber: '',
        deliveryMethod: 'shipped',
        startDate: '',
        endDate: '',
        set: '',
        recipient: '',
        received: false
      });
      const [image, setImage] = useState(null);
      const [orders, setOrders] = useState([]);
      const [uploading, setUploading] = useState(false);
      const [error, setError] = useState(null);

      // Fetch orders from Firestore
      useEffect(() => {
        if (!db) return;
        const unsubscribe = firebase.onSnapshot(firebase.collection(db, 'orders'), (snapshot) => {
          const ordersData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setOrders(ordersData);
        }, (err) => {
          console.error('Firestore fetch error:', err);
          setError('Failed to fetch orders. Please try again.');
        });
        return () => unsubscribe();
      }, []);

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
      };

      const handleImageChange = (e) => {
        if (e.target.files[0]) {
          setImage(e.target.files[0]);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!db || !storage) {
          setError('Firebase not initialized. Check configuration.');
          return;
        }
        setUploading(true);
        setError(null);

        try {
          let imageUrl = '';
          if (image) {
            const storageRef = firebase.ref(storage, `images/${image.name}`);
            await firebase.uploadBytes(storageRef, image);
            imageUrl = await firebase.getDownloadURL(storageRef);
          }

          await firebase.addDoc(firebase.collection(db, 'orders'), {
            ...formData,
            imageUrl,
            timestamp: new Date()
          });

          // Reset form
          setFormData({
            itemName: '',
            pickupFrom: '',
            orderNumber: '',
            deliveryMethod: 'shipped',
            startDate: '',
            endDate: '',
            set: '',
            recipient: '',
            received: false
          });
          setImage(null);
          alert('Order submitted successfully!');
        } catch (error) {
          console.error('Error submitting order:', error);
          setError('Error submitting order. Please try again.');
        } finally {
          setUploading(false);
        }
      };

      const toggleReceived = async (id, currentStatus) => {
        if (!db) {
          setError('Firebase not initialized.');
          return;
        }
        try {
          await firebase.updateDoc(firebase.doc(db, 'orders', id), {
            received: !currentStatus
          });
        } catch (error) {
          console.error('Error updating received status:', error);
          setError('Error updating status. Please try again.');
        }
      };

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-6 text-center">Hardware Order Management</h1>
          
          {/* Error Display */}
          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}

          {/* Order Form */}
          <div className="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 className="text-2xl font-semibold mb-4">New Order</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <input
                type="text"
                name="itemName"
                value={formData.itemName}
                onChange={handleInputChange}
                placeholder="Item Name"
                className="w-full p-2 border rounded"
                required
              />
              <input
                type="text"
                name="pickupFrom"
                value={formData.pickupFrom}
                onChange={handleInputChange}
                placeholder="Pickup From"
                className="w-full p-2 border rounded"
                required
              />
              <input
                type="text"
                name="orderNumber"
                value={formData.orderNumber}
                onChange={handleInputChange}
                placeholder="Order Number"
                className="w-full p-2 border rounded"
                required
              />
              <select
                name="deliveryMethod"
                value={formData.deliveryMethod}
                onChange={handleInputChange}
                className="w-full p-2 border rounded"
              >
                <option value="shipped">Shipped</option>
                <option value="pickup">Pickup</option>
              </select>
              <div className="flex space-x-2">
                <input
                  type="date"
                  name="startDate"
                  value={formData.startDate}
                  onChange={handleInputChange}
                  placeholder="Shipping Start Date"
                  className="w-full p-2 border rounded"
                  required
                />
                <input
                  type="date"
                  name="endDate"
                  value={formData.endDate}
                  onChange={handleInputChange}
                  placeholder="Shipping End Date"
                  className="w-full p-2 border rounded"
                  required
                />
              </div>
              <input
                type="file"
                onChange={handleImageChange}
                accept="image/*"
                className="w-full p-2 border rounded"
              />
              <input
                type="text"
                name="set"
                value={formData.set}
                onChange={handleInputChange}
                placeholder="Designated Set"
                className="w-full p-2 border rounded"
                required
              />
              <input
                type="text"
                name="recipient"
                value={formData.recipient}
                onChange={handleInputChange}
                placeholder="Recipient"
                className="w-full p-2 border rounded"
                required
              />
              <button
                type="submit"
                disabled={uploading}
                className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 disabled:bg-blue-300"
              >
                {uploading ? 'Submitting...' : 'Submit Order'}
              </button>
            </form>
          </div>

          {/* Orders List */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {orders.map(order => (
              <div key={order.id} className="bg-white p-4 rounded-lg shadow-md">
                <h3 className="text-lg font-semibold">{order.itemName}</h3>
                <p><strong>Pickup From:</strong> {order.pickupFrom}</p>
                <p><strong>Order Number:</strong> {order.orderNumber}</p>
                <p><strong>Delivery:</strong> {order.deliveryMethod}</p>
                <p><strong>Shipping Dates:</strong> {order.startDate} to {order.endDate}</p>
                <p><strong>Set:</strong> {order.set}</p>
                <p><strong>Recipient:</strong> {order.recipient}</p>
                <p><strong>Received:</strong> {order.received ? 'Yes' : 'No'}</p>
                {order.imageUrl && (
                  <img src={order.imageUrl} alt="Order item" className="w-full h-32 object-cover rounded mt-2" />
                )}
                <button
                  onClick={() => toggleReceived(order.id, order.received)}
                  className={`mt-2 p-2 rounded w-full ${
                    order.received ? 'bg-gray-500' : 'bg-green-500'
                  } text-white hover:opacity-90`}
                >
                  {order.received ? 'Mark as Not Received' : 'Mark as Received'}
                </button>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Render the app
    try {
      ReactDOM.render(<App />, document.getElementById('root'));
    } catch (error) {
      console.error('React render error:', error);
      document.getElementById('root').innerHTML = '<div class="text-red-500 text-center">Error loading application. Please check console for details.</div>';
    }
  </script>
</body>
</html>
