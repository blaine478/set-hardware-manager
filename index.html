<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hardware Tracking App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.9/babel.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script id="firebase-app" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script id="firebase-firestore" src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .hover-scale { transition: transform 0.3s; }
    .hover-scale:hover { transform: scale(1.05); }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
  <div id="root" class="min-h-screen"></div>
  <script type="text/javascript">
    // Firebase Initialization with Robust Retry
    function initializeFirebase(attempts = 0, maxAttempts = 50) {
      if (typeof firebase === 'undefined') {
        if (attempts >= maxAttempts) {
          console.error("Firebase failed to load after", maxAttempts, "attempts. Check CDN or network.");
          window.firebase = { error: "Firebase not available. Please check your connection." };
          return;
        }
        console.warn("Firebase not loaded yet. Retrying in 100ms... (Attempt", attempts + 1, ")");
        setTimeout(() => initializeFirebase(attempts + 1, maxAttempts), 100);
        return;
      }
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyCRbUS6L7O4I_gGaaCmCyHi7wt_WgMwZFc",
          authDomain: "set-hardware.firebaseapp.com",
          projectId: "set-hardware",
          storageBucket: "set-hardware.firebasestorage.app",
          messagingSenderId: "613195230835",
          appId: "1:613195230835:web:c9e3e78db3e8b99f6ec406"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.firebase = {
          db,
          collection: firebase.firestore.collection,
          addDoc: (collectionRef, data) => collectionRef.add(data),
          getDocs: (collectionRef) => collectionRef.get(),
          updateDoc: (docRef, data) => docRef.update(data),
          doc: firebase.firestore.doc
        };
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Firebase initialization failed:", error);
        window.firebase = { error: "Firebase initialization failed: " + error.message };
      }
    }

    // Wait for Firebase scripts to load
    const firebaseAppScript = document.getElementById('firebase-app');
    const firebaseFirestoreScript = document.getElementById('firebase-firestore');
    firebaseAppScript.onload = firebaseFirestoreScript.onload = () => {
      if (firebaseAppScript.readyState === 'complete' && firebaseFirestoreScript.readyState === 'complete') {
        initializeFirebase();
      }
    };
  </script>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // HomePage Component
    const HomePage = () => {
      const [items, setItems] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchItems = async () => {
          try {
            if (window.firebase.error) throw new Error(window.firebase.error);
            if (!window.firebase.db) throw new Error("Firebase database not initialized.");
            const querySnapshot = await window.firebase.getDocs(window.firebase.db.collection('items'));
            const itemsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
          } catch (error) {
            console.error("Error fetching items:", error);
            setError("Failed to load items. Please check your connection or try again.");
          }
        };
        fetchItems();
      }, []);

      const markReceived = async (id, receivedBy) => {
        try {
          if (window.firebase.error) throw new Error(window.firebase.error);
          const itemRef = window.firebase.db.doc(`items/${id}`);
          await window.firebase.updateDoc(itemRef, {
            actualDelivery: new Date().toLocaleDateString(),
            receivedBy,
            receiptTimestamp: new Date().toLocaleString(),
            status: 'Active'
          });
          setItems(items.map(item =>
            item.id === id ? {
              ...item,
              actualDelivery: new Date().toLocaleDateString(),
              receivedBy,
              receiptTimestamp: new Date().toLocaleString(),
              status: 'Active'
            } : item
          ));
        } catch (error) {
          console.error("Error marking item received:", error);
          setError("Failed to mark item as received.");
        }
      };

      return (
        <div className="p-6 fade-in">
          <h2 className="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Incoming Items</h2>
          {error && <p className="text-red-500 mb-4">{error}</p>}
          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {items.filter(item => item.status === 'Incoming').map(item => (
              <div key={item.id} className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover-scale">
                <p className="text-gray-800 dark:text-gray-200"><strong>ID:</strong> {item.id}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Description:</strong> {item.description || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Set Number:</strong> {item.setNumber || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Overseer:</strong> {item.overseer || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Expected Delivery:</strong> {item.expectedDelivery || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Destination Notes:</strong> {item.destinationNotes || 'N/A'}</p>
                <input
                  type="text"
                  placeholder="Your Name"
                  className="border p-3 mt-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
                  onChange={(e) => {
                    if (e.target.value) markReceived(item.id, e.target.value);
                  }}
                />
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ActiveSetsPage Component
    const ActiveSetsPage = () => {
      const [items, setItems] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchItems = async () => {
          try {
            if (window.firebase.error) throw new Error(window.firebase.error);
            if (!window.firebase.db) throw new Error("Firebase database not initialized.");
            const querySnapshot = await window.firebase.getDocs(window.firebase.db.collection('items'));
            const itemsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
          } catch (error) {
            console.error("Error fetching items:", error);
            setError("Failed to load items. Please check your connection or try again.");
          }
        };
        fetchItems();
      }, []);

      const markSetCompleted = async (setNumber) => {
        try {
          if (window.firebase.error) throw new Error(window.firebase.error);
          const querySnapshot = await window.firebase.getDocs(window.firebase.db.collection('items'));
          querySnapshot.docs.forEach(async (doc) => {
            if (doc.data().setNumber === setNumber) {
              await window.firebase.updateDoc(window.firebase.db.doc(`items/${doc.id}`), {
                completed: true,
                status: 'Completed'
              });
            }
          });
          setItems(items.map(item =>
            item.setNumber === setNumber ? { ...item, completed: true, status: 'Completed' } : item
          ));
        } catch (error) {
          console.error("Error marking set completed:", error);
          setError("Failed to mark set as completed.");
        }
      };

      const activeSets = [...new Set(items.filter(item => item.status === 'Active').map(item => item.setNumber))];

      return (
        <div className="p-6 fade-in">
          <h2 className="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Active Sets</h2>
          {error && <p className="text-red-500 mb-4">{error}</p>}
          {activeSets.map(setNumber => (
            <div key={setNumber} className="mb-8">
              <h3 className="text-2xl font-semibold text-gray-800 dark:text-white">{setNumber}</h3>
              <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {items.filter(item => item.setNumber === setNumber && item.status === 'Active').map(item => (
                  <div key={item.id} className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover-scale">
                    <p className="text-gray-800 dark:text-gray-200"><strong>ID:</strong> {item.id}</p>
                    <p className="text-gray-800 dark:text-gray-200"><strong>Description:</strong> {item.description || 'N/A'}</p>
                    <p className="text-gray-800 dark:text-gray-200"><strong>Overseer:</strong> {item.overseer || 'N/A'}</p>
                    <p className="text-gray-800 dark:text-gray-200"><strong>Received By:</strong> {item.receivedBy || 'N/A'}</p>
                    <p className="text-gray-800 dark:text-gray-200"><strong>Receipt Timestamp:</strong> {item.receiptTimestamp || 'N/A'}</p>
                  </div>
                ))}
              </div>
              <button
                className="mt-4 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition"
                onClick={() => markSetCompleted(setNumber)}
              >
                Mark Set Completed
              </button>
            </div>
          ))}
        </div>
      );
    };

    // OrderFormPage Component
    const OrderFormPage = () => {
      const [items, setItems] = useState([]);
      const [formData, setFormData] = useState({
        description: '', setNumber: '', overseer: '', orderedBy: '', orderDate: '', expectedDelivery: '', destinationNotes: ''
      });
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchItems = async () => {
          try {
            if (window.firebase.error) throw new Error(window.firebase.error);
            if (!window.firebase.db) throw new Error("Firebase database not initialized.");
            const querySnapshot = await window.firebase.getDocs(window.firebase.db.collection('items'));
            const itemsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
          } catch (error) {
            console.error("Error fetching items:", error);
            setError("Failed to load items. Please check your connection or try again.");
          }
        };
        fetchItems();
      }, []);

      const generateItemId = () => {
        return 'H' + Math.floor(1000 + Math.random() * 9000);
      };

      const addItem = async () => {
        try {
          if (window.firebase.error) throw new Error(window.firebase.error);
          const newItem = {
            id: generateItemId(),
            ...formData,
            actualDelivery: '',
            receivedBy: '',
            receiptTimestamp: '',
            status: 'Incoming',
            completed: false
          };
          await window.firebase.db.collection('items').doc(newItem.id).set(newItem);
          setItems([...items, newItem]);
          setFormData({ description: '', setNumber: '', overseer: '', orderedBy: '', orderDate: '', expectedDelivery: '', destinationNotes: '' });
          alert('Order added! Buyer can view it below.');
        } catch (error) {
          console.error("Error adding item:", error);
          setError("Failed to add order. Please try again.");
        }
      };

      const downloadPO = (item) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Purchase Order', 20, 20);
        doc.setFontSize(12);
        doc.text(`Item ID: ${item.id}`, 20, 40);
        doc.text(`Description: ${item.description || 'N/A'}`, 20, 50);
        doc.text(`Set Number: ${item.setNumber || 'N/A'}`, 20, 60);
        doc.text(`Overseer: ${item.overseer || 'N/A'}`, 20, 70);
        doc.text(`Ordered By: ${item.orderedBy || 'N/A'}`, 20, 80);
        doc.text(`Order Date: ${item.orderDate || 'N/A'}`, 20, 90);
        doc.text(`Expected Delivery: ${item.expectedDelivery || 'N/A'}`, 20, 100);
        doc.text(`Destination Notes: ${item.destinationNotes || 'N/A'}`, 20, 110);
        doc.save(`PO_${item.id}.pdf`);
      };

      return (
        <div className="p-6 fade-in">
          <h2 className="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Order Form</h2>
          {error && <p className="text-red-500 mb-4">{error}</p>}
          <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <input
              type="text"
              placeholder="Description"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
            />
            <input
              type="text"
              placeholder="Set Number"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.setNumber}
              onChange={(e) => setFormData({ ...formData, setNumber: e.target.value })}
            />
            <input
              type="text"
              placeholder="Overseer"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.overseer}
              onChange={(e) => setFormData({ ...formData, overseer: e.target.value })}
            />
            <input
              type="text"
              placeholder="Ordered By"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.orderedBy}
              onChange={(e) => setFormData({ ...formData, orderedBy: e.target.value })}
            />
            <input
              type="date"
              placeholder="Order Date"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.orderDate}
              onChange={(e) => setFormData({ ...formData, orderDate: e.target.value })}
            />
            <input
              type="date"
              placeholder="Expected Delivery"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.expectedDelivery}
              onChange={(e) => setFormData({ ...formData, expectedDelivery: e.target.value })}
            />
            <textarea
              placeholder="Destination Notes"
              className="border p-3 mb-4 w-full rounded-lg dark:bg-gray-700 dark:text-white"
              value={formData.destinationNotes}
              onChange={(e) => setFormData({ ...formData, destinationNotes: e.target.value })}
            />
            <button
              className="bg-blue-600 text-white p-3 rounded-lg w-full hover:bg-blue-700 transition"
              onClick={addItem}
            >
              Add Order
            </button>
          </div>
          <h3 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-white">New Orders for Buyer</h3>
          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {items.filter(item => item.status === 'Incoming').map(item => (
              <div key={item.id} className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover-scale">
                <p className="text-gray-800 dark:text-gray-200"><strong>ID:</strong> {item.id}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Description:</strong> {item.description || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Set Number:</strong> {item.setNumber || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Overseer:</strong> {item.overseer || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Order Date:</strong> {item.orderDate || 'N/A'}</p>
                <p className="text-gray-800 dark:text-gray-200"><strong>Expected Delivery:</strong> {item.expectedDelivery || 'N/A'}</p>
                <button
                  className="mt-4 bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition"
                  onClick={() => downloadPO(item)}
                >
                  Download P.O. (PDF)
                </button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ArchivePage Component
    const ArchivePage = () => {
      const [items, setItems] = useState([]);
      const [error, setError] = useState(null);

      useEffect(() => {
        const fetchItems = async () => {
          try {
            if (window.firebase.error) throw new Error(window.firebase.error);
            if (!window.firebase.db) throw new Error("Firebase database not initialized.");
            const querySnapshot = await window.firebase.getDocs(window.firebase.db.collection('items'));
            const itemsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
          } catch (error) {
            console.error("Error fetching items:", error);
            setError("Failed to load items. Please check your connection or try again.");
          }
        };
        fetchItems();
      }, []);

      const completedSets = [...new Set(items.filter(item => item.completed).map(item => item.setNumber))];

      return (
        <div className="p-6 fade-in">
          <h2 className="text-3xl font-bold mb-6 text-gray-800 dark:text-white">Completed Sets Archive</h2>
          {error && <p className="text-red-500 mb-4">{error}</p>}
          <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {completedSets.map(setNumber => (
              <div key={setNumber} className="mb-8">
                <h3 className="text-2xl font-semibold text-gray-800 dark:text-white">{setNumber}</h3>
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                  {items.filter(item => item.setNumber === setNumber && item.completed).map(item => (
                    <div key={item.id} className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover-scale">
                      <p className="text-gray-800 dark:text-gray-200"><strong>ID:</strong> {item.id}</p>
                      <p className="text-gray-800 dark:text-gray-200"><strong>Description:</strong> {item.description || 'N/A'}</p>
                      <p className="text-gray-800 dark:text-gray-200"><strong>Overseer:</strong> {item.overseer || 'N/A'}</p>
                      <p className="text-gray-800 dark:text-gray-200"><strong>Received By:</strong> {item.receivedBy || 'N/A'}</p>
                      <p className="text-gray-800 dark:text-gray-200"><strong>Receipt Timestamp:</strong> {item.receiptTimestamp || 'N/A'}</p>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [page, setPage] = useState('home');
      const [darkMode, setDarkMode] = useState(false);

      useEffect(() => {
        document.body.className = darkMode ? 'bg-gray-900' : 'bg-gray-100';
      }, [darkMode]);

      return (
        <div className="container mx-auto">
          <nav className="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center shadow-lg">
            <div className="flex space-x-6">
              <button onClick={() => setPage('home')} className="hover:underline text-lg font-medium">Home</button>
              <button onClick={() => setPage('active')} className="hover:underline text-lg font-medium">Active Sets</button>
              <button onClick={() => setPage('order')} className="hover:underline text-lg font-medium">Order Form</button>
              <button onClick={() => setPage('archive')} className="hover:underline text-lg font-medium">Archive</button>
            </div>
            <button
              onClick={() => setDarkMode(!darkMode)}
              className="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white p-2 rounded-full"
            >
              {darkMode ? 'Light Mode' : 'Dark Mode'}
            </button>
          </nav>
          {page === 'home' && <HomePage />}
          {page === 'active' && <ActiveSetsPage />}
          {page === 'order' && <OrderFormPage />}
          {page === 'archive' && <ArchivePage />}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
