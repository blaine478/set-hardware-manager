<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware Tracker</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 0;
            color: #1d1d1f;
        }
        #root {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 24px;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #007aff;
            transition: background-color 0.3s;
        }
        .tab.active {
            background-color: #007aff;
            color: #ffffff;
        }
        .form, .order-list, .settings-section {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-row input, .item-row select {
            flex: 1;
            margin-right: 10px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
        }
        textarea {
            height: 100px;
        }
        label {
            margin-right: 20px;
        }
        button {
            background-color: #007aff;
            color: #ffffff;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .add-item-button {
            width: auto;
            padding: 10px 20px;
            margin-left: 10px;
        }
        .remove-item-button {
            background-color: #ff3b30;
            width: auto;
            padding: 10px;
            margin-left: 10px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li.order-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .order-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .expand-button {
            background-color: #007aff;
            padding: 5px 10px;
            width: auto;
            margin-left: auto;
        }
        .details {
            margin-top: 10px;
            padding: 10px;
            background-color: #e5e5ea;
            border-radius: 8px;
        }
        .status-button {
            background-color: #34c759;
            margin-top: 10px;
        }
        .archive-button {
            background-color: #ff9500;
        }
        .error {
            color: #ff3b30;
            text-align: center;
        }
        .loading {
            text-align: center;
            font-size: 18px;
            color: #007aff;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat CDNs for namespaced API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/11.10.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/11.10.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/11.10.0/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('Incoming');
            const [orders, setOrders] = useState([]);
            const [sets, setSets] = useState([]);
            const [receivers, setReceivers] = useState([]);
            const [newSetName, setNewSetName] = useState('');
            const [newReceiverName, setNewReceiverName] = useState('');
            const [items, setItems] = useState([{ item: '', set: '' }]);
            const [description, setDescription] = useState('');
            const [orderNumber, setOrderNumber] = useState('');
            const [orderType, setOrderType] = useState('pickup');
            const [pickupDate, setPickupDate] = useState('');
            const [deliveryStartDate, setDeliveryStartDate] = useState('');
            const [deliveryEndDate, setDeliveryEndDate] = useState('');
            const [store, setStore] = useState('');
            const [recipient, setRecipient] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(true);
            const [expandedOrders, setExpandedOrders] = useState({});

            const firebaseConfig = {
                apiKey: "AIzaSyCRbUS6L7O4I_gGaaCmCyHi7wt_WgMwZFc",
                authDomain: "set-hardware.firebaseapp.com",
                projectId: "set-hardware",
                storageBucket: "set-hardware.firebasestorage.app",
                messagingSenderId: "613195230835",
                appId: "1:613195230835:web:c9e3e78db3e8b99f6ec406"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            const auth = firebase.auth();
            const db = firebase.firestore();

            useEffect(() => {
                const handleAuth = () => {
                    auth.signInAnonymously()
                        .then(() => setLoading(false))
                        .catch(err => {
                            setError(err.message);
                            setLoading(false);
                        });
                };

                const unsubscribe = auth.onAuthStateChanged(currentUser => {
                    setUser(currentUser);
                    if (!currentUser) {
                        handleAuth();
                    } else {
                        setLoading(false);
                    }
                });

                return unsubscribe;
            }, []);

            useEffect(() => {
                if (user) {
                    const unsubscribeOrders = db.collection('orders').where('orderedBy', '==', user.uid).onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setOrders(data);
                    });

                    const unsubscribeSets = db.collection('sets').where('userId', '==', user.uid).onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSets(data);
                    });

                    const unsubscribeReceivers = db.collection('receivers').where('userId', '==', user.uid).onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setReceivers(data);
                    });

                    return () => {
                        unsubscribeOrders();
                        unsubscribeSets();
                        unsubscribeReceivers();
                    };
                }
            }, [user]);

            const addItemRow = () => {
                setItems([...items, { item: '', set: '' }]);
            };

            const removeItemRow = (index) => {
                const newItems = items.filter((_, i) => i !== index);
                setItems(newItems);
            };

            const updateItem = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                setItems(newItems);
            };

            const handleOrder = async () => {
                try {
                    const orderData = {
                        items,
                        description,
                        orderNumber,
                        type: orderType,
                        store,
                        recipient,
                        orderedBy: user.uid,
                        status: 'ordered',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (orderType === 'pickup') {
                        orderData.pickupDate = pickupDate;
                    } else {
                        orderData.deliveryStartDate = deliveryStartDate;
                        orderData.deliveryEndDate = deliveryEndDate;
                    }
                    await db.collection('orders').add(orderData);
                    // Reset form
                    setItems([{ item: '', set: '' }]);
                    setDescription('');
                    setOrderNumber('');
                    setOrderType('pickup');
                    setPickupDate('');
                    setDeliveryStartDate('');
                    setDeliveryEndDate('');
                    setStore('');
                    setRecipient('');
                } catch (err) {
                    setError('Failed to place order: ' + err.message);
                }
            };

            const updateStatus = async (id, newStatus) => {
                try {
                    await db.collection('orders').doc(id).update({ status: newStatus });
                } catch (err) {
                    setError('Failed to update status: ' + err.message);
                }
            };

            const markReceived = async (id) => {
                const receivedBy = window.prompt('Received by whom?');
                if (receivedBy) {
                    try {
                        await db.collection('orders').doc(id).update({
                            status: 'received',
                            receivedBy
                        });
                    } catch (err) {
                        setError('Failed to mark received: ' + err.message);
                    }
                }
            };

            const toggleExpand = (id) => {
                setExpandedOrders(prev => ({ ...prev, [id]: !prev[id] }));
            };

            const addSet = async () => {
                if (newSetName.trim()) {
                    try {
                        await db.collection('sets').add({
                            name: newSetName,
                            userId: user.uid
                        });
                        setNewSetName('');
                    } catch (err) {
                        setError('Failed to add set: ' + err.message);
                    }
                }
            };

            const deleteSet = async (id) => {
                try {
                    await db.collection('sets').doc(id).delete();
                } catch (err) {
                    setError('Failed to delete set: ' + err.message);
                }
            };

            const addReceiver = async () => {
                if (newReceiverName.trim()) {
                    try {
                        await db.collection('receivers').add({
                            name: newReceiverName,
                            userId: user.uid
                        });
                        setNewReceiverName('');
                    } catch (err) {
                        setError('Failed to add receiver: ' + err.message);
                    }
                }
            };

            const deleteReceiver = async (id) => {
                try {
                    await db.collection('receivers').doc(id).delete();
                } catch (err) {
                    setError('Failed to delete receiver: ' + err.message);
                }
            };

            const handleSetKeyDown = (e) => {
                if (e.key === 'Enter') {
                    addSet();
                }
            };

            const handleReceiverKeyDown = (e) => {
                if (e.key === 'Enter') {
                    addReceiver();
                }
            };

            const filteredOrders = orders.filter(order => {
                if (tab === 'Incoming') return order.status === 'ordered';
                if (tab === 'Received') return order.status === 'received';
                if (tab === 'Archived') return order.status === 'archived';
                return false;
            });

            if (loading) {
                return <div className="loading">Loading...</div>;
            }

            if (error) {
                return <p className="error">{error}</p>;
            }

            return (
                <div>
                    <h1>Hardware Tracker</h1>
                    <div className="tabs">
                        {['Incoming', 'Received', 'Archived', 'Order', 'Settings'].map(t => (
                            <div
                                key={t}
                                className={`tab ${tab === t ? 'active' : ''}`}
                                onClick={() => setTab(t)}
                            >
                                {t}
                            </div>
                        ))}
                    </div>
                    {tab === 'Order' ? (
                        <div className="form">
                            <h2>Items</h2>
                            {items.map((it, index) => (
                                <div key={index} className="item-row">
                                    <input 
                                        value={it.item} 
                                        onChange={e => updateItem(index, 'item', e.target.value)} 
                                        placeholder="Item" 
                                    />
                                    <select 
                                        value={it.set} 
                                        onChange={e => updateItem(index, 'set', e.target.value)}
                                    >
                                        <option value="">Select Set</option>
                                        {sets.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                    {index > 0 && <button className="remove-item-button" onClick={() => removeItemRow(index)}>Remove</button>}
                                </div>
                            ))}
                            <button className="add-item-button" onClick={addItemRow}>Add Item</button>

                            <textarea 
                                value={description} 
                                onChange={e => setDescription(e.target.value)} 
                                placeholder="Description" 
                            />

                            <input 
                                value={orderNumber} 
                                onChange={e => setOrderNumber(e.target.value)} 
                                placeholder="Order Number" 
                            />

                            <div>
                                <label>
                                    <input 
                                        type="radio" 
                                        value="pickup" 
                                        checked={orderType === 'pickup'} 
                                        onChange={e => setOrderType(e.target.value)} 
                                    />
                                    Pickup
                                </label>
                                <label>
                                    <input 
                                        type="radio" 
                                        value="delivery" 
                                        checked={orderType === 'delivery'} 
                                        onChange={e => setOrderType(e.target.value)} 
                                    />
                                    Delivery
                                </label>
                            </div>

                            {orderType === 'pickup' ? (
                                <input 
                                    type="date" 
                                    value={pickupDate} 
                                    onChange={e => setPickupDate(e.target.value)} 
                                />
                            ) : (
                                <>
                                    <input 
                                        type="date" 
                                        value={deliveryStartDate} 
                                        onChange={e => setDeliveryStartDate(e.target.value)} 
                                        placeholder="Delivery Start Date" 
                                    />
                                    <input 
                                        type="date" 
                                        value={deliveryEndDate} 
                                        onChange={e => setDeliveryEndDate(e.target.value)} 
                                        placeholder="Delivery End Date" 
                                    />
                                </>
                            )}

                            <input 
                                value={store} 
                                onChange={e => setStore(e.target.value)} 
                                placeholder="Store/Shipper" 
                            />

                            <select 
                                value={recipient} 
                                onChange={e => setRecipient(e.target.value)}
                            >
                                <option value="">Select Recipient</option>
                                {receivers.map(r => <option key={r.id} value={r.name}>{r.name}</option>)}
                            </select>

                            <button onClick={handleOrder}>Place Order</button>
                        </div>
                    ) : tab === 'Settings' ? (
                        <div className="settings-section">
                            <h2>Set Names</h2>
                            <div className="input-group">
                                <input 
                                    value={newSetName} 
                                    onChange={e => setNewSetName(e.target.value)} 
                                    onKeyDown={handleSetKeyDown}
                                    placeholder="New Set Name" 
                                />
                                <button className="add-item-button" onClick={addSet}>Add</button>
                            </div>
                            <ul>
                                {sets.map(s => (
                                    <li key={s.id}>
                                        {s.name}
                                        <button className="delete-button" onClick={() => deleteSet(s.id)}>Delete</button>
                                    </li>
                                ))}
                            </ul>

                            <h2>Receiver Names</h2>
                            <div className="input-group">
                                <input 
                                    value={newReceiverName} 
                                    onChange={e => setNewReceiverName(e.target.value)} 
                                    onKeyDown={handleReceiverKeyDown}
                                    placeholder="New Receiver Name" 
                                />
                                <button className="add-item-button" onClick={addReceiver}>Add</button>
                            </div>
                            <ul>
                                {receivers.map(r => (
                                    <li key={r.id}>
                                        {r.name}
                                        <button className="delete-button" onClick={() => deleteReceiver(r.id)}>Delete</button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    ) : (
                        <ul className="order-list">
                            {filteredOrders.map(order => (
                                <li key={order.id} className="order-item">
                                    <div className="order-summary">
                                        <span>Order #{order.orderNumber} for {order.recipient}</span>
                                        <button className="expand-button" onClick={() => toggleExpand(order.id)}>
                                            {expandedOrders[order.id] ? 'Collapse' : 'Expand'}
                                        </button>
                                    </div>
                                    {expandedOrders[order.id] && (
                                        <div className="details">
                                            <p><strong>Items:</strong></p>
                                            <ul>
                                                {order.items.map((it, idx) => (
                                                    <li key={idx}>{it.item} (Set: {it.set})</li>
                                                ))}
                                            </ul>
                                            <p><strong>Description:</strong> {order.description}</p>
                                            <p><strong>Type:</strong> {order.type}</p>
                                            {order.type === 'pickup' ? (
                                                <p><strong>Pickup Date:</strong> {order.pickupDate}</p>
                                            ) : (
                                                <p><strong>Delivery Dates:</strong> {order.deliveryStartDate} to {order.deliveryEndDate}</p>
                                            )}
                                            <p><strong>Store/Shipper:</strong> {order.store}</p>
                                            {order.receivedBy && <p><strong>Received By:</strong> {order.receivedBy}</p>}
                                        </div>
                                    )}
                                    {tab === 'Incoming' && <button className="status-button" onClick={() => markReceived(order.id)}>Received By</button>}
                                    {tab === 'Received' && <button className="archive-button" onClick={() => updateStatus(order.id, 'archived')}>Archive</button>}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
